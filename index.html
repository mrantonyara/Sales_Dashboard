<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Dashboard — Liquid Glass (iOS26)</title>
  <style>
    :root{
      --bg-1: #0f1724; /* deep */
      --glass-1: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.09);
      --accent: #4facfe;
      --muted: rgba(255,255,255,0.72);
      --card-radius: 18px;
      --tile-gap: 16px;
      --text: 15px;
    }

    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(180deg, #071023 0%, #0b1430 100%);
      -webkit-font-smoothing:antialiased;
      color: #fff;
      padding:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      background-image: radial-gradient( circle at 10% 10%, rgba(79,172,254,0.03), transparent 10%), radial-gradient( circle at 90% 90%, rgba(245,87,108,0.02), transparent 10%);
    }

    /* Container */
    .container{
      width:100%;
      max-width:1100px;
      transform: translateY(0);
      animation: appear 620ms cubic-bezier(.2,.9,.2,1);
    }
    @keyframes appear{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:none}}

    /* Main glass card */
    .glass-card{
      border-radius:28px;
      padding:26px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      box-shadow: 0 8px 28px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      overflow:hidden;
    }

    /* header */
    .top{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px
    }
    h1{font-size:20px;letter-spacing:-0.2px;margin:0;font-weight:600;color:var(--muted)}

    .update{
      display:flex;align-items:center;gap:10px;font-size:13px;color:rgba(255,255,255,0.75)
    }
    .pulse{
      width:9px;height:9px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px rgba(79,172,254,0.28);animation:pulse 1.8s infinite
    }
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.45);opacity:0.6}100%{transform:none}}

    /* Grid exactly as you asked: 3 columns. We'll place tiles by name order. */
    .stores-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:var(--tile-gap);
      align-items:start;
      margin-bottom:18px;
    }

    /* Tile style — Liquid Glass minimal */
    .store-card{
      border-radius:14px;
      padding:14px 14px;
      min-height:110px;
      display:flex;flex-direction:column;gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 6px 18px rgba(2,6,23,0.5), inset 0 1px 0 rgba(255,255,255,0.02);
      position:relative;overflow:hidden;transition:transform .25s cubic-bezier(.2,.9,.2,1), box-shadow .25s
    }
    .store-card:before{
      content:"";position:absolute;inset:0;background:linear-gradient(120deg, rgba(255,255,255,0.02), transparent 30%);pointer-events:none;mix-blend-mode:overlay;opacity:0.9
    }
    .store-card:hover{transform:translateY(-6px);box-shadow:0 16px 36px rgba(2,6,23,0.62)}

    .store-name{font-weight:700;font-size:15px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .store-meta{font-size:12px;color:rgba(255,255,255,0.66)}

    .stats{display:flex;gap:8px;align-items:center}
    .stat{flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:10px;text-align:center}
    .stat .label{font-size:12px;color:rgba(255,255,255,0.66)}
    .stat .value{font-weight:700;font-size:16px;color:#fff}

    .warning{color:#ffb336;margin-left:6px}

    /* Total card — big & prominent */
    .total-card{
      border-radius:14px;padding:18px;display:flex;flex-direction:column;justify-content:center;align-items:center;
      background: linear-gradient(135deg, rgba(79,172,254,0.08), rgba(0,242,254,0.02));
      border:1px solid rgba(79,172,254,0.12);
      box-shadow: 0 12px 36px rgba(79,172,254,0.06);
    }
    .total-label{font-size:13px;color:rgba(255,255,255,0.9);letter-spacing:1px;text-transform:uppercase}
    .total-value{font-size:22px;font-weight:800;background:linear-gradient(90deg,#fff,#dff6ff);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    /* small helpers */
    .muted{color:rgba(255,255,255,0.66)}

    /* accessibility */
    @media (prefers-reduced-motion:reduce){
      .pulse, .store-card, .glass-card{animation:none;transition:none}
    }

    /* responsive */
    @media (max-width:820px){
      .stores-grid{grid-template-columns:repeat(2,1fr)}
      .total-card{grid-column:1/ -1}
    }
    @media (max-width:480px){
      .stores-grid{grid-template-columns:1fr}
      .total-card{grid-column:auto}
      .store-card{min-height:92px}
      h1{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="glass-card" role="region" aria-label="Панель продаж">
      <div class="top">
        <h1>Sales • Liquid Glass (iOS26)</h1>
        <div class="update" aria-live="polite">
          <div class="pulse" aria-hidden="true"></div>
          <div id="updateTime">Загрузка данных...</div>
        </div>
      </div>

      <main id="mainContent">
        <div id="content">
          <div class="stores-grid" id="storesGrid" aria-live="polite">
            <!-- tiles will be injected here in fixed positions -->
          </div>

          <!-- total card placed as last item to match layout (will occupy 2 columns on wide screens) -->
          <div id="totalWrapper" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:var(--tile-gap);">
            <!-- This area will be filled by pStore card (col 1) and Итого (col2-3) programmatically -->
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ---- Configuration ----
    const reportApiUrl = "https://api.github.com/repos/mrantonyara/iOSWidgetUniversam/contents/Sales_Report.txt";
    const historyApiUrl = "https://api.github.com/repos/mrantonyara/iOSWidgetUniversam/contents/sales_data.txt";

    // Desired tile order and exact labels you asked for
    const desiredOrder = [
      'Универсам','Назар','Балапан',
      'Pozitiv','Спутник','На рахате',
      'pStore'
    ];

    // Helper: format number with spaces
    function formatAmount(amount){ return String(amount).replace(/\B(?=(\d{3})+(?!\d))/g,' '); }

    // ---- Data loading helpers (kept compatible with your previous logic) ----
    async function fetchText(url){
      try{
        const res = await fetch(url,{headers:{'Accept':'application/vnd.github.v3+json','Cache-Control':'no-cache'}});
        if(!res.ok) throw new Error('api');
        const j = await res.json();
        if(j && j.content && j.encoding === 'base64') return atob(j.content.replace(/\n/g,''));
        throw new Error('badresp');
      }catch(e){
        // fallback to raw
        const rawUrl = url.replace('api.github.com/repos','raw.githubusercontent.com').replace('/contents/','/master/');
        const r = await fetch(rawUrl + '?t=' + Date.now());
        return await r.text();
      }
    }

    function parseHistorical(content){
      if(!content) return {};
      return content.split('\n').map(l=>l.trim()).filter(Boolean).reduce((acc,line)=>{
        const [k,v] = line.split(':').map(s=>s && s.trim());
        acc[k] = parseInt(v,10) || 0; return acc;
      },{});
    }

    function processReport(content, historical){
      if(!content) return {dateLine:'Нет данных', entries:[], totalChecks:0, totalAmount:0};
      const lines = content.split('\n').map(l=>l.trim()).filter(Boolean);
      const dateLine = lines.shift() || 'Нет данных';
      const today = new Date(); const dd = String(today.getDate()).padStart(2,'0'); const mm = String(today.getMonth()+1).padStart(2,'0'); const currentDate = `${dd}.${mm}.${today.getFullYear()}`;

      let totalChecks=0, totalAmount=0; const entries=[];

      for(let i=0;i<lines.length;){
        const loc = lines[i].split(':')[0].trim();
        let date='', details='';
        if(lines[i+1] && lines[i+1].includes('на сумму')){ date=currentDate; details=lines[i+1]; i+=2; }
        else if(lines[i+1] && lines[i+2]){ date = lines[i+1].split(' ')[0].trim(); details = lines[i+2]; i+=3; }
        else { i++; continue; }

        details = details.replace(',00','').trim();
        const countMatch = details.match(/(\d+)\s+чек/); // try to be robust
        const checkCount = countMatch ? parseInt(countMatch[1],10) : (parseInt(details.split(' ')[0],10) || 0);
        const amountPart = details.split('на сумму')[1] ? details.split('на сумму')[1].replace(/[^\d]/g,'') : '0';
        const amount = parseInt(amountPart,10) || 0;

        const isOutdated = (checkCount === 0 || date !== currentDate);
        const histCount = historical[loc] || 0;
        const sumCount = (date === currentDate) ? histCount + checkCount : histCount;

        if(date === currentDate){ totalChecks += checkCount; totalAmount += amount; }
        entries.push({location:loc,date,checkCount,amount,sumCount,isOutdated});
      }
      return {dateLine, entries, totalChecks, totalAmount};
    }

    // ---- Render logic with fixed tile positions ----
    function renderFixedGrid(data){
      const grid = document.getElementById('storesGrid');
      const totalWrapper = document.getElementById('totalWrapper');
      grid.innerHTML = '';
      totalWrapper.innerHTML = '';

      // create lookup by location (try exact and fuzzy matches)
      const lookup = {};
      data.entries.forEach(e=>{ lookup[e.location] = e; });

      function findByName(name){
        // exact match
        if(lookup[name]) return lookup[name];
        // fuzzy: some source names may contain the requested word
        for(const k in lookup){ if(k.includes(name) || name.includes(k)) return lookup[k]; }
        return null;
      }

      // generate tiles in order of desiredOrder
      for(const name of desiredOrder){
        const entry = findByName(name);
        const tile = document.createElement('div');
        tile.className = 'store-card';
        tile.setAttribute('role','group');
        tile.setAttribute('aria-label', name + ' — магазин');

        const title = document.createElement('div'); title.className='store-name'; title.textContent = name;
        const meta = document.createElement('div'); meta.className='store-meta';

        if(entry){
          meta.innerHTML = `${entry.date} ${entry.isOutdated? '• устарело':''}`;
        }else{
          meta.textContent = 'Нет данных';
        }

        const stats = document.createElement('div'); stats.className='stats';

        const s1 = document.createElement('div'); s1.className='stat'; s1.innerHTML = `<div class="label">Чеки сегодня</div><div class="value">${entry? entry.checkCount: 0}</div>`;
        const s2 = document.createElement('div'); s2.className='stat'; s2.innerHTML = `<div class="label">Всего чеков</div><div class="value">${entry? entry.sumCount: 0}${entry && entry.sumCount > 100 ? '<span class="warning">⚠</span>':''}</div>`;
        const s3 = document.createElement('div'); s3.className='stat'; s3.innerHTML = `<div class="label">Сумма</div><div class="value">${entry? formatAmount(entry.amount) : '0'} ₸</div>`;

        stats.appendChild(s1); stats.appendChild(s2); stats.appendChild(s3);
        tile.appendChild(title); tile.appendChild(meta); tile.appendChild(stats);
        grid.appendChild(tile);
      }

      // pStore should be first cell of the last row — we'll move it into a 3-column small grid for that row
      // create pStore card (will copy from generated grid's last child or create empty)
      const pIndex = desiredOrder.indexOf('pStore');
      const pCard = grid.children[pIndex] ? grid.children[pIndex].cloneNode(true) : document.createElement('div');
      // total card — Итого
      const totalCard = document.createElement('div'); totalCard.className='total-card'; totalCard.setAttribute('role','status');
      totalCard.innerHTML = `<div class="total-label">Итого за день</div><div class="total-value">${data.totalChecks} чеков • ${formatAmount(data.totalAmount)} ₸</div>`;

      // Build a 3-column row: col1 pStore, col2-3 totalCard
      const rowGrid = document.createElement('div');
      rowGrid.style.display='grid';
      rowGrid.style.gridTemplateColumns='1fr 2fr';
      rowGrid.style.gap='16px';
      rowGrid.style.marginTop='8px';

      // ensure pCard has correct classes
      pCard.className = 'store-card';

      rowGrid.appendChild(pCard);
      rowGrid.appendChild(totalCard);
      totalWrapper.appendChild(rowGrid);

      // update header time
      document.getElementById('updateTime').textContent = data.dateLine + ' • ' + new Date().toLocaleTimeString();
    }

    // ---- Main loader ----
    async function loadDashboard(){
      try{
        const [r,h] = await Promise.all([fetchText(reportApiUrl), fetchText(historyApiUrl)]);
        const historical = parseHistorical(h);
        const data = processReport(r,historical);
        renderFixedGrid(data);
      }catch(err){
        console.error(err);
        const grid = document.getElementById('storesGrid');
        grid.innerHTML = '<div style="grid-column:1/-1;padding:18px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)">Ошибка загрузки данных. Проверьте URL или CORS.</div>';
        document.getElementById('updateTime').textContent = 'Ошибка загрузки';
      }
    }

    loadDashboard();
    // refresh every 60s
    setInterval(loadDashboard, 60000);
  </script>
</body>
</html>
